generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "relationJoins", "nativeDistinct", "postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, uuidOssp(map: "uuid-ossp")]
}

model Account {
  id         String  @id @default(uuid()) @db.Uuid
  name       String
  logoBlobId String? @unique @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  LogoBlob Blob? @relation(name: "logo", fields: [logoBlobId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  User     User[]
  Resource Resource[]
  Field    Field[]
  Schema   Schema[]
  Blob     Blob[]     @relation(name: "owner")
  File     File[]
}

model Blob {
  id        String @id @default(uuid()) @db.Uuid
  accountId String @db.Uuid
  name      String
  mimeType  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  OwnedBy Account  @relation(name: "owner", fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  LogoFor Account? @relation(name: "logo")
  User    User?
  File    File[]
}

model User {
  id                   String    @id @default(uuid()) @db.Uuid
  accountId            String    @db.Uuid
  email                String    @unique
  firstName            String?
  lastName             String?
  tsAndCsSignedAt      DateTime?
  passwordHash         String?
  requirePasswordReset Boolean
  imageBlobId          String?   @unique @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ImageBlob Blob?   @relation(fields: [imageBlobId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  Value     Value[]
}

enum ResourceType {
  Line
  Item
  Order
  Bill
  Vendor
}

model Resource {
  id        String       @id @default(uuid()) @db.Uuid
  accountId String       @db.Uuid
  type      ResourceType
  key       Int          @db.Integer
  revision  Int          @db.Integer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Account       Account         @relation(fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ResourceField ResourceField[]
  Value         Value[]

  @@unique([accountId, type, key, revision])
}

model ResourceField {
  resourceId String @db.Uuid
  fieldId    String @db.Uuid
  valueId    String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Field    Field    @relation(fields: [fieldId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Value    Value    @relation(fields: [valueId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([resourceId, fieldId])
}

enum FieldType {
  Checkbox
  Contact
  Date
  File
  Money
  MultiSelect
  Number
  Resource
  RichText
  Select
  Text
  User
}

model Field {
  id           String        @id @default(uuid()) @db.Uuid
  accountId    String        @db.Uuid
  type         FieldType
  name         String
  isEditable   Boolean
  isVersioned  Boolean
  resourceType ResourceType?
  templateId   String?       @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Option             Option[]
  Account            Account         @relation(fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ResourceFieldValue ResourceField[]
  SectionField       SectionField[]

  @@unique([accountId, name])
  @@unique([accountId, templateId])
}

model Option {
  id      String @id @default(uuid()) @db.Uuid
  fieldId String @db.Uuid
  name    String @db.VarChar
  order   Int    @db.Integer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Field       Field         @relation(fields: [fieldId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Value       Value[]
  ValueOption ValueOption[]
}

model File {
  id        String @id @default(uuid()) @db.Uuid
  accountId String @db.Uuid
  name      String
  blobId    String @unique @db.Uuid

  Blob    Blob    @relation(fields: [blobId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Account Account @relation(fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Value   Value[]
}

model Contact {
  valueId String  @id @db.Uuid
  name    String?
  title   String?
  email   String?
  phone   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Value Value @relation(fields: [valueId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Value {
  id         String    @id @default(uuid()) @db.Uuid
  boolean    Boolean?
  date       DateTime? @db.Date
  number     Float?
  string     String?
  userId     String?   @db.Uuid
  optionId   String?   @db.Uuid
  resourceId String?   @db.Uuid
  fileId     String?   @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  File               File?           @relation(fields: [fileId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  User               User?           @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  Option             Option?         @relation(fields: [optionId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  Resource           Resource?       @relation(fields: [resourceId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  ValueOption        ValueOption[]
  ResourceFieldValue ResourceField[]
  Contact            Contact?
}

model ValueOption {
  valueId  String @db.Uuid
  optionId String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Value  Value  @relation(fields: [valueId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Option Option @relation(fields: [optionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([valueId, optionId])
}

model Schema {
  id           String       @id @default(uuid()) @db.Uuid
  accountId    String       @db.Uuid
  resourceType ResourceType
  isSystem     Boolean

  Account Account   @relation(fields: [accountId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Section Section[]

  @@unique([accountId, resourceType, isSystem])
}

model Section {
  id       String @id @default(uuid()) @db.Uuid
  schemaId String @db.Uuid
  name     String
  order    Int    @db.Integer

  Schema       Schema         @relation(fields: [schemaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  SectionField SectionField[]

  @@unique([schemaId, name])
}

model SectionField {
  sectionId String @db.Uuid
  fieldId   String @db.Uuid
  order     Int    @db.Integer

  Section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Field   Field   @relation(fields: [fieldId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([sectionId, fieldId])
}
